# 🔐 后台管理页面使用指南

## 📋 功能概述

后台管理页面用于查看和管理 Supabase 中存储的所有代币记录。

**访问地址：**
```
http://localhost:3000/admin
```

---

## ✅ 已实现功能

### 1️⃣ 数据展示

**展示字段：**
- ✅ **Logo** - 代币图标（支持外部图片，无图显示默认图）
- ✅ **钱包地址** - 前6位...后4位格式
- ✅ **代币地址** - 前6位...后4位格式
- ✅ **符号** - USDT, BNB 等
- ✅ **名称** - Tether USD 等
- ✅ **余额** - 格式化后的余额
- ✅ **USD 价值** - 美元价值（格式化千分位）
- ✅ **授权状态** - 已授权 ✅ / 未授权 ⭕
- ✅ **创建时间** - YYYY-MM-DD HH:mm 格式

**排序规则：**
- 按 `usd_value` 字段从大到小排序
- 价值最高的代币显示在最前面

---

### 2️⃣ 数据筛选

**支持的筛选条件：**

| 筛选项 | 类型 | 说明 |
|-------|------|------|
| 钱包地址 | 输入框 | 模糊搜索，支持部分地址 |
| 代币符号 | 输入框 | 模糊搜索，如 "USDT", "BNB" |
| 代币名称 | 输入框 | 模糊搜索，如 "Tether" |
| 授权状态 | 下拉选择 | 全部 / 已授权 / 未授权 |
| 最小 USD 价值 | 数字输入 | 筛选价值 >= 此值的记录 |
| 最大 USD 价值 | 数字输入 | 筛选价值 <= 此值的记录 |
| 开始日期 | 日期选择 | 筛选创建时间 >= 此日期 |
| 结束日期 | 日期选择 | 筛选创建时间 <= 此日期 |

**筛选特性：**
- ✅ 实时筛选（输入时自动触发）
- ✅ 多条件组合（AND 逻辑）
- ✅ 显示当前筛选结果数量
- ✅ 一键重置所有筛选条件

---

### 3️⃣ Web3 登录

- ✅ 使用 RainbowKit 钱包连接
- ✅ 支持 BSC 链
- ✅ 显示连接状态
- ✅ 与前端页面共用相同的钱包连接

---

### 4️⃣ 分页功能

- ✅ 每页显示 20 条记录
- ✅ 显示总页数和当前页
- ✅ 上一页 / 下一页按钮
- ✅ 页码快速跳转（最多显示5个页码）

---

## ⏸️ UI 已预留（功能未实现）

### 1️⃣ 刷新授权状态按钮

**位置：** 页面右上角

**样式：** 
- 币安黄色边框
- 带刷新图标
- 当前状态：禁用（`disabled`）

**预期功能（待实现）：**
- 点击后重新从 Supabase 获取最新数据
- 显示 loading 状态
- 完成后提示"刷新成功"

---

### 2️⃣ 提币按钮

**位置：** 每条记录的操作列

**样式：**
- 币安黄色边框
- 小尺寸按钮
- 当前状态：禁用（`disabled`）

**预期功能（待实现）：**
- 点击后触发提币流程
- 可能需要二次确认
- 显示交易进度
- 完成后更新记录状态

---

## 🎨 UI 设计

### Logo 显示逻辑

```typescript
// 1. 如果有 logo 字段且不为空，显示外部图片
<Image src={token.logo} alt={token.symbol} />

// 2. 如果图片加载失败，显示默认图片
onError={(e) => {
  e.target.src = DEFAULT_TOKEN_LOGO
}}

// 3. 默认图片
const DEFAULT_TOKEN_LOGO = 'https://via.placeholder.com/40/F0B90B/000000?text=Token'
```

---

### 授权状态徽章

**已授权：**
```
┌─────────┐
│ ✅ 已授权 │  ← 绿色背景
└─────────┘
```

**未授权：**
```
┌─────────┐
│ ⭕ 未授权 │  ← 灰色背景
└─────────┘
```

---

### 币安风格主题

- **主色：** 币安黄 `#F0B90B`
- **按钮：** 黄色边框 + 黄色悬停效果
- **表格：** 斑马纹效果（间隔行背景色）
- **字体：** 地址使用等宽字体 `font-mono`

---

## 📊 数据示例

### 表格显示效果

```
┌──────┬───────────┬───────────┬──────┬─────────────┬──────────┬──────────┬──────┬──────────────┬──────┐
│ Logo │ 钱包地址   │ 代币地址   │ 符号 │ 名称         │   余额   │ USD价值  │ 授权 │  创建时间    │ 操作 │
├──────┼───────────┼───────────┼──────┼─────────────┼──────────┼──────────┼──────┼──────────────┼──────┤
│ [🪙] │ 0x1234... │ 0x55d3... │ USDT │ Tether USD  │ 16,491.99│ $16,491  │ ✅   │ 2024-01-24   │[提币]│
│ [🪙] │ 0x1234... │ 0xce24... │ U    │ United      │ 4,540.72 │ $4,537   │ ⭕   │ 2024-01-23   │[提币]│
│ [🪙] │ 0x5678... │ 0xa69d... │ CE   │ CE Token    │ 0.018    │ $0.06    │ ⭕   │ 2024-01-22   │[提币]│
└──────┴───────────┴───────────┴──────┴─────────────┴──────────┴──────────┴──────┴──────────────┴──────┘
```

---

## 🔍 筛选示例

### 示例 1: 查找特定钱包的所有代币

**筛选条件：**
- 钱包地址：`0x1234`
- 其他条件：不填

**结果：**
- 显示钱包地址包含 `0x1234` 的所有记录

---

### 示例 2: 查找高价值的 USDT

**筛选条件：**
- 代币符号：`USDT`
- 最小 USD 价值：`1000`
- 授权状态：`未授权`

**结果：**
- 显示 USDT 代币
- USD 价值 >= 1000
- 未授权的记录

---

### 示例 3: 查找最近7天的记录

**筛选条件：**
- 开始日期：`2024-01-18`
- 结束日期：`2024-01-25`

**结果：**
- 显示创建时间在这个范围内的所有记录

---

## 🧪 测试步骤

### 步骤 1: 访问管理页面

```bash
# 启动开发服务器
npm run dev

# 访问管理页面
http://localhost:3000/admin
```

---

### 步骤 2: 连接钱包

1. 点击右上角 "Connect Wallet" 按钮
2. 选择钱包（如 MetaMask）
3. 确认连接
4. 查看连接状态

---

### 步骤 3: 查看数据

**预期结果：**
- ✅ 表格显示所有代币记录
- ✅ 记录按 USD 价值从大到小排序
- ✅ Logo 正常显示（或显示默认图）
- ✅ 授权状态徽章显示正确
- ✅ 显示记录总数

---

### 步骤 4: 测试筛选

**测试钱包地址筛选：**
```
输入：0x1234
预期：只显示地址包含 "0x1234" 的记录
```

**测试代币符号筛选：**
```
输入：USDT
预期：只显示符号包含 "USDT" 的记录
```

**测试授权状态筛选：**
```
选择：已授权
预期：只显示 authorized = true 的记录
```

**测试价值范围筛选：**
```
最小值：100
最大值：10000
预期：只显示 100 <= usd_value <= 10000 的记录
```

---

### 步骤 5: 测试分页

1. 如果总记录数 > 20，应显示分页
2. 点击"下一页"，查看第 2 页数据
3. 点击页码，快速跳转
4. 点击"上一页"，返回第 1 页

---

### 步骤 6: 重置筛选

1. 设置多个筛选条件
2. 点击"重置筛选"按钮
3. 查看所有筛选条件是否清空
4. 页面是否返回第 1 页

---

## 🔧 API 端点

### GET `/api/admin/get-tokens`

**功能：** 获取代币列表（支持筛选和分页）

**查询参数：**

```typescript
{
  wallet_address?: string      // 钱包地址（模糊搜索）
  symbol?: string              // 代币符号（模糊搜索）
  name?: string                // 代币名称（模糊搜索）
  authorized?: 'all' | 'true' | 'false'  // 授权状态
  min_usd_value?: number       // 最小 USD 价值
  max_usd_value?: number       // 最大 USD 价值
  start_date?: string          // 开始日期 (YYYY-MM-DD)
  end_date?: string            // 结束日期 (YYYY-MM-DD)
  page?: number                // 页码（默认 1）
  limit?: number               // 每页数量（默认 20）
}
```

**响应示例：**

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "wallet_address": "0x1234...",
      "token_address": "0x55d3...",
      "symbol": "USDT",
      "name": "Tether USD",
      "logo": "https://...",
      "balance_formatted": "16491.99",
      "usd_value": 16491.845233664,
      "authorized": true,
      "created_at": "2024-01-24T10:30:00Z"
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 20,
  "totalPages": 8
}
```

---

## ⚠️ 注意事项

### 1. Logo 加载失败处理

- ✅ 如果外部图片加载失败，自动显示默认图
- ✅ 使用 `onError` 事件处理
- ✅ 默认图使用 `placeholder` 服务

### 2. 数据排序

- ✅ 数据在 **API 层面**就按 `usd_value` 排序
- ✅ 使用 Supabase 的 `order()` 方法
- ✅ `nullsFirst: false` 确保 null 值在最后

### 3. 筛选性能

- ✅ 所有筛选都在 **服务端**完成
- ✅ 使用 Supabase 的查询能力
- ✅ 支持索引优化

### 4. 分页逻辑

- ✅ 使用 Supabase 的 `range()` 方法
- ✅ 支持精确的分页计数
- ✅ 页码根据当前页动态调整显示

---

## 🚀 后续开发计划

### 功能待实现：

1. **刷新授权状态按钮**
   - 重新获取数据
   - 显示 loading 状态
   - 成功提示

2. **提币按钮**
   - 触发提币流程
   - 二次确认弹窗
   - 交易状态显示
   - 更新记录状态

3. **批量操作**
   - 多选功能
   - 批量提币
   - 批量导出

4. **导出功能**
   - 导出 CSV
   - 导出 Excel
   - 筛选结果导出

5. **权限控制**
   - 管理员验证
   - 操作日志
   - 访问限制

---

## 📁 文件结构

```
/app/admin/
  └── page.tsx                  # 管理页面主文件

/app/api/admin/
  └── get-tokens/
      └── route.ts              # 获取代币列表 API

/ADMIN_PAGE_GUIDE.md            # 本说明文档
```

---

## 🔍 故障排查

### 问题 1: 页面显示空白

**原因：**
- RainbowKit 未正确初始化
- Web3Provider 未包裹组件

**解决：**
- 确保 `app/layout.tsx` 中已包含 `Web3Provider`

---

### 问题 2: 图片不显示

**原因：**
- Next.js 图片域名未配置

**解决：**
在 `next.config.mjs` 中添加：
```javascript
images: {
  domains: [
    'logo.moralis.io',
    'via.placeholder.com'
  ]
}
```

---

### 问题 3: 筛选不生效

**原因：**
- API 端点未正确处理参数

**解决：**
- 检查浏览器 Network 标签
- 查看 API 请求参数
- 检查服务端日志

---

### 问题 4: 分页错误

**原因：**
- 总数计算错误
- 分页逻辑错误

**解决：**
- 检查 `count: 'exact'` 是否启用
- 验证 `range()` 参数

---

**管理页面开发完成！🎉**

现在可以访问 `http://localhost:3000/admin` 进行测试！
